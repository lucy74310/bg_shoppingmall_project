<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cart">

	<insert id="insert_cart" parameterType="cartvo">
		<![CDATA[
			INSERT INTO cart (member_no, non_member_no, product_option_no, count, price)
			values(#{member_no} , #{non_member_no}, #{product_option_no}, #{count}, #{price})
		]]>
		<selectKey keyProperty="no" resultType="long" order="AFTER">
			select last_insert_id();
		</selectKey> 
	</insert>
	
	<update id="update_cart" parameterType="cartvo">
		<![CDATA[
			update cart 
				set
				count = #{count}
			where
				no = #{no}  
		]]>
	</update>	

	<delete id="delete_cart" parameterType="long">
		delete from cart 
		 where 
		 	no = #{no} 
		 	<choose>
		 		<when test="non_member_no != null">
		 			and non_member_no = #{non_member_no} 
		 		</when>
		 		<otherwise>
		 			and member_no = #{member_no}
		 		</otherwise>
		 	</choose>
	</delete>
	
	<select id="get_member_cart_list" resultType="cartvo" parameterType="long">
	<![CDATA[
		select 
				c.no, c.member_no, c.product_option_no, c.count, c.price, po.po_name, pi.url as main_image_url
		from cart as c join product_option as po on c.product_option_no = po.no 
        join product as p on p.no = po.product_no
        left join product_image as pi on p.no = pi.product_no
		where c.member_no = #{no} and pi.is_main='Y'
	]]>
	</select>
	
	
	<select id="get_nonmember_cart_list" resultType="cartvo" parameterType="long">
		<![CDATA[
			select 
					c.no, c.member_no, c.product_option_no, c.count, c.price, po.po_name, pi.url as main_image_url
			from cart as c join product_option as po on c.product_option_no = po.no 
	        join product as p on p.no = po.product_no
	        left join product_image as pi on p.no = pi.product_no
			where c.non_member_no = #{no} and pi.is_main='Y'
		]]> 
	</select>
	
	<select id="check_has_when_member" resultType="string" parameterType="map">
		<![CDATA[
			select 
				count  
			from cart 
			where 
				member_no = #{member_no}
				and product_option_no = #{po_no}
		]]>
	</select>
	
	<select id="check_has_when_nonmember" resultType="string" parameterType="map">
		<![CDATA[
			select 
				count 
			from cart 
			where 
				non_member_no = #{non_member_no}
				and product_option_no = #{po_no}
		]]> 
	</select>
		
</mapper>
